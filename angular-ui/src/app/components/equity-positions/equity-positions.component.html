<div class="equity-positions-container">
  <!-- Toast for notifications -->
  <p-toast></p-toast>

  <!-- Simple Header -->
  <div class="header">
    <h1>Equity Positions Management</h1>
    <div class="status">Backend: {{ backendStatus }}</div>
    <div class="actions">
      <p-button 
        label="Load Sample Data" 
        icon="pi pi-download" 
        (onClick)="loadSampleData()" 
        [disabled]="isLoading"
        severity="primary">
      </p-button>
      <p-button 
        label="Clear All" 
        icon="pi pi-trash" 
        (onClick)="clearAll()" 
        [disabled]="isLoading"
        severity="danger">
      </p-button>
    </div>
  </div>

  <!-- Error Message -->
  <p-message 
    *ngIf="errorMessage" 
    severity="error" 
    [text]="errorMessage"
    styleClass="mb-3">
  </p-message>

  <!-- Loading Spinner -->
  <div class="loading" *ngIf="isLoading">
    <p-progressSpinner 
      strokeWidth="4" 
      fill="var(--surface-ground)" 
      animationDuration=".5s">
    </p-progressSpinner>
    <p>Processing...</p>
  </div>

  <div class="main-content">
    <!-- Positions Display -->
    <p-card header="Current Positions" styleClass="mb-3">
      <div class="positions" *ngIf="positions.length > 0; else noPositions">
        <div class="position" *ngFor="let position of positions">
          <span class="security">{{ position.securityCode }}</span>
          <span class="quantity" [class.positive]="position.quantity > 0" [class.negative]="position.quantity < 0">
            {{ formatPosition(position.quantity) }}
          </span>
        </div>
      </div>
      <ng-template #noPositions>
        <p>No positions available.</p>
      </ng-template>
    </p-card>

    <!-- Single Transaction Form -->
    <p-card [header]="isEditing ? 'Edit Transaction' : 'Add Single Transaction'" styleClass="mb-3">
      <form class="form" (ngSubmit)="isEditing ? updateTransaction() : addTransaction()">
        <div class="form-row">
          <div class="field">
            <label for="transactionId" class="block text-900 font-medium mb-2">Transaction ID</label>
            <p-inputNumber 
              id="transactionId"
              [(ngModel)]="newTransaction.transactionId" 
              name="transactionId"
              [required]="isEditing" 
              [disabled]="isEditing" 
              [placeholder]="isEditing ? '' : 'Auto-generated'"
              [showButtons]="false"
              styleClass="w-full">
            </p-inputNumber>
          </div>
          <div class="field">
            <label for="tradeId" class="block text-900 font-medium mb-2">Trade ID</label>
            <p-inputNumber 
              id="tradeId"
              [(ngModel)]="newTransaction.tradeId" 
              name="tradeId" 
              required
              [showButtons]="false"
              styleClass="w-full">
            </p-inputNumber>
          </div>
          <div class="field">
            <label for="version" class="block text-900 font-medium mb-2">Version</label>
            <p-inputNumber 
              id="version"
              [(ngModel)]="newTransaction.version" 
              name="version" 
              required
              [showButtons]="false"
              styleClass="w-full">
            </p-inputNumber>
          </div>
        </div>
        
        <div class="form-row">
          <div class="field">
            <label for="securityCode" class="block text-900 font-medium mb-2">Security Code</label>
            <input 
              pInputText 
              id="securityCode"
              [(ngModel)]="newTransaction.securityCode" 
              name="securityCode" 
              required
              class="w-full">
          </div>
          <div class="field">
            <label for="quantity" class="block text-900 font-medium mb-2">Quantity</label>
            <p-inputNumber 
              id="quantity"
              [(ngModel)]="newTransaction.quantity" 
              name="quantity" 
              required
              [showButtons]="false"
              styleClass="w-full">
            </p-inputNumber>
          </div>
        </div>
        
        <div class="form-row">
          <div class="field">
            <label for="action" class="block text-900 font-medium mb-2">Action</label>
            <p-select 
              id="action"
              [(ngModel)]="newTransaction.action" 
              name="action" 
              [options]="actionOptions"
              optionLabel="label"
              optionValue="value"
              placeholder="Select Action"
              required
              styleClass="w-full">
            </p-select>
          </div>
          <div class="field">
            <label for="side" class="block text-900 font-medium mb-2">Side</label>
            <p-select 
              id="side"
              [(ngModel)]="newTransaction.side" 
              name="side" 
              [options]="sideOptions"
              optionLabel="label"
              optionValue="value"
              placeholder="Select Side"
              required
              styleClass="w-full">
            </p-select>
          </div>
        </div>
        
        <div class="form-actions">
          <p-button 
            [label]="isEditing ? 'Update Transaction' : 'Add Transaction'"
            icon="pi pi-check"
            type="submit"
            severity="primary">
          </p-button>
          <p-button 
            *ngIf="isEditing"
            label="Cancel" 
            icon="pi pi-times"
            (onClick)="cancelEdit()"
            severity="secondary"
            styleClass="p-button-outlined">
          </p-button>
        </div>
      </form>
    </p-card>

    <!-- Bulk Transactions -->
    <!-- <p-card header="Bulk Transactions" styleClass="mb-3">
      <div class="field">
        <label for="bulkTransactions" class="block text-900 font-medium mb-2">Transactions (CSV format)</label>
        <p-textarea 
          id="bulkTransactions"
          [(ngModel)]="bulkTransactionsText" 
          name="bulkTransactions"
          placeholder="[transactionId],1,1,REL,50,INSERT,BUY&#10;[transactionId],2,1,ITC,40,INSERT,SELL&#10;Note: Transaction ID is optional and will be auto-generated if not provided"
          rows="6"
          styleClass="w-full">
        </p-textarea>
      </div>
      <p-button 
        label="Process Bulk Transactions" 
        icon="pi pi-upload"
        (onClick)="processBulkTransactions()"
        severity="secondary">
      </p-button>
    </p-card> -->

    <!-- Transactions History -->
    <p-card header="Transaction History" styleClass="mb-3">
      <p-table 
        [value]="transactions" 
        [tableStyle]="{'min-width': '50rem'}"
        styleClass="p-datatable-sm"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
        [rows]="10"
        [paginator]="true"
        responsiveLayout="scroll">
        
        <ng-template pTemplate="header">
          <tr>
            <th>Transaction ID</th>
            <th>Trade ID</th>
            <th>Version</th>
            <th>Security Code</th>
            <th>Quantity</th>
            <th>Action</th>
            <th>Side</th>
            <th>Actions</th>
          </tr>
        </ng-template>
        
        <ng-template pTemplate="body" let-transaction>
          <tr>
            <td>{{ transaction.transactionId }}</td>
            <td>{{ transaction.tradeId }}</td>
            <td>{{ transaction.version }}</td>
            <td>{{ transaction.securityCode }}</td>
            <td>{{ transaction.quantity }}</td>
            <td>
              <span class="p-badge" 
                    [class]="transaction.action === 'INSERT' ? 'p-badge-success' : 
                             transaction.action === 'UPDATE' ? 'p-badge-warning' : 'p-badge-danger'">
                {{ transaction.action }}
              </span>
            </td>
            <td>
              <span class="p-badge" 
                    [class]="transaction.side === 'BUY' ? 'p-badge-success' : 'p-badge-danger'">
                {{ transaction.side === 'BUY' ? 'Buy' : 'Sell' }}
              </span>
            </td>
            <td>
              <p-button 
                icon="pi pi-pencil" 
                severity="primary" 
                size="small"
                (onClick)="editTransaction(transaction)"
                pTooltip="Edit Transaction">
              </p-button>
            </td>
          </tr>
        </ng-template>
        
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8" class="text-center p-4">No transactions available.</td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>
  </div>
</div> 